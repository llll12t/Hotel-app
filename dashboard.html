<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8">
    <title>Dashboard Appointment</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="flex">
      <!-- Sidebar -->
      <div class="w-64 bg-white p-4 shadow">
        <h1 class="text-xl font-bold mb-4">Dashboard Appointment</h1>
        <nav class="space-y-2">
          <a href="#" class="block px-3 py-2 rounded hover:bg-gray-200">Calendar</a>
          <a href="#" class="block px-3 py-2 rounded hover:bg-gray-200">List</a>
          <a href="#" class="block px-3 py-2 rounded hover:bg-gray-200">Member</a>
          <a href="#" class="block px-3 py-2 rounded hover:bg-gray-200">Setting</a>
        </nav>
      </div>
      <!-- Main Content -->
      <div class="flex-1 p-6">
        <!-- Header bar -->
        <div class="flex items-center justify-between mb-6">
          <div class="text-xl font-bold">รายการจองห้อง</div>
          <div class="flex items-center space-x-2">
            <input type="text" id="searchInput" placeholder="ค้นหา..." class="border rounded px-2 py-1 text-sm">
            <button class="bg-gray-200 text-sm px-3 py-1 rounded" id="searchBtn">ค้นหา</button>
          </div>
        </div>
        <!-- Table list -->
        <div class="bg-white p-4 rounded shadow">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b">
                <th class="text-left py-2">ลูกค้า</th>
                <th class="text-left py-2">สถานะ</th>
                <th class="text-left py-2">ห้อง</th>
                <th class="text-left py-2">วันเริ่ม</th>
                <th class="text-left py-2">วันออก</th>
                <th class="text-right py-2">Actions</th>
              </tr>
            </thead>
            <tbody id="appointmentList"></tbody>
          </table>
        </div>
        <!-- Edit Form (Full width) -->
        <div class="bg-white p-4 rounded shadow mt-4 w-full" id="editForm" style="display:none;">
          <h2 class="font-bold mb-2">แก้ไขข้อมูล</h2>
          <div class="mb-2">
            <label class="block text-sm">สถานะ</label>
            <select id="editStatus" class="border rounded px-2 py-1 text-sm w-full">
              <option value="จอง">จอง</option>
              <option value="ชำระแล้ว">ชำระแล้ว</option>
              <option value="ยกเลิก">ยกเลิก</option>
              <option value="เสร็จสิ้น">เสร็จสิ้น</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="block text-sm">ชำระเงิน</label>
            <select id="editPayment" class="border rounded px-2 py-1 text-sm w-full">
              <option value="รอการชำระเงิน">รอการชำระเงิน</option>
              <option value="โอนธนาคาร">โอนธนาคาร</option>
              <option value="พร้อมเพย์">พร้อมเพย์</option>
              <option value="จ่ายหน้างาน">จ่ายหน้างาน</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="block text-sm">บันทึกเพิ่มเติม</label>
            <input type="text" id="editNote" class="border rounded px-2 py-1 text-sm w-full">
          </div>
          <div class="mb-2">
            <label class="block text-sm">เชคอิน (DD-MM-YYYY HH:mm)</label>
            <input type="datetime-local" id="editCheckIn2" class="border rounded px-2 py-1 text-sm w-full">
          </div>
          <div class="mb-2">
            <label class="block text-sm">เชคเอาต์ (DD-MM-YYYY HH:mm)</label>
            <input type="datetime-local" id="editCheckOut2" class="border rounded px-2 py-1 text-sm w-full">
          </div>
          <div class="flex justify-end space-x-2">
            <button id="cancelEdit" class="bg-gray-200 px-3 py-1 rounded text-sm">ยกเลิก</button>
            <button id="saveEdit" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">บันทึก</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCXa-UgZvYdi5aTtEveDXrkun3u7lqN24iyFLRgUit6ocfhbTLF5gsrcfiOZ8mEUU9/exec"; // ใส่ URL ของ Web App (dashboard.gs)
      let currentEditId = null;
      let appointmentData = [];

      // ฟังก์ชันช่วยแปลง ISO date string เป็น DD-MM-YYYY (ถ้า input จาก Apps Script เป็น ISO)
      function formatISODateToDMY(isoStr) {
        var d = new Date(isoStr);
        if (isNaN(d)) return isoStr;
        var dd = ("0" + d.getDate()).slice(-2);
        var mm = ("0" + (d.getMonth() + 1)).slice(-2);
        var yyyy = d.getFullYear();
        return dd + "-" + mm + "-" + yyyy;
      }

      async function fetchAppointments() {
        try {
          let res = await fetch(`${SCRIPT_URL}?action=getAppointments`);
          let data = await res.json();
          appointmentData = data;
          renderAppointments(data);
        } catch (err) {
          console.error(err);
        }
      }

      function renderAppointments(list) {
        const container = document.getElementById("appointmentList");
        container.innerHTML = "";
        list.forEach(item => {
          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-gray-50";
          
          const tdCustomer = document.createElement("td");
          tdCustomer.className = "py-2";
          tdCustomer.textContent = item["ชื่อผู้เช่า"] || "-";
          
          const tdStatus = document.createElement("td");
          tdStatus.className = "py-2";
          tdStatus.textContent = item["สถานะ"] || "";
          
          const tdRoom = document.createElement("td");
          tdRoom.className = "py-2";
          tdRoom.textContent = item["ชื่อห้องพัก"] || "";
          
          const tdStart = document.createElement("td");
          tdStart.className = "py-2";
          tdStart.textContent = formatISODateToDMY(item["วันที่เข้าพัก"] || "");
          
          const tdEnd = document.createElement("td");
          tdEnd.className = "py-2";
          tdEnd.textContent = formatISODateToDMY(item["วันที่ออก"] || "");
          
          const tdActions = document.createElement("td");
          tdActions.className = "py-2 text-right";
          const btnEdit = document.createElement("button");
          btnEdit.textContent = "...";
          btnEdit.className = "bg-gray-200 px-2 py-1 rounded text-sm";
          btnEdit.addEventListener("click", () => {
            currentEditId = item["ไอดี"];
            document.getElementById("editStatus").value = item["สถานะ"] || "จอง";
            document.getElementById("editPayment").value = item["ชำระเงิน"] || "รอการชำระเงิน";
            document.getElementById("editNote").value = item["บันทึกเพิ่มเติม"] || "";
            document.getElementById("editCheckIn2").value = item["เชคอิน"] || "";
            document.getElementById("editCheckOut2").value = item["เชคเอาต์"] || "";
            document.getElementById("editForm").style.display = "block";
          });
          tdActions.appendChild(btnEdit);
          
          tr.appendChild(tdCustomer);
          tr.appendChild(tdStatus);
          tr.appendChild(tdRoom);
          tr.appendChild(tdStart);
          tr.appendChild(tdEnd);
          tr.appendChild(tdActions);
          container.appendChild(tr);
        });
      }

      document.getElementById("saveEdit").addEventListener("click", async () => {
        if (!currentEditId) return;
        const status = document.getElementById("editStatus").value;
        const payment = document.getElementById("editPayment").value;
        const note = document.getElementById("editNote").value;
        const checkIn2 = document.getElementById("editCheckIn2").value;  // datetime-local (YYYY-MM-DDTHH:mm)
        const checkOut2 = document.getElementById("editCheckOut2").value; // datetime-local
        let body = {
          action: "updateAppointment",
          id: currentEditId,
          status: status,
          payment: payment,
          note: note,
          checkIn2: checkIn2,
          checkOut2: checkOut2
        };
        try {
          let res = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(body)
          });
          let text = await res.text();
          console.log("Update response:", text);
          document.getElementById("editForm").style.display = "none";
          currentEditId = null;
          fetchAppointments();
        } catch (err) {
          console.error(err);
        }
      });

      document.getElementById("cancelEdit").addEventListener("click", () => {
        document.getElementById("editForm").style.display = "none";
        currentEditId = null;
      });

      document.addEventListener("DOMContentLoaded", () => {
        fetchAppointments();
      });
    </script>
  </body>
</html>
