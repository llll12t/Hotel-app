<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÇ‡∏≠‡∏°‡∏™‡πÄ‡∏ï‡∏¢‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include Flatpickr CSS and JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Include config.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API_URL -->
  <script src="config.js"></script>
  <!-- LIFF SDK (‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ uncomment ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ liff.init) -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <!-- Custom CSS for loading spinner -->
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 64px;
      height: 64px;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen relative">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
    <div class="loader"></div>
  </div>

  <!-- STEP 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á (Index) -->
  <div id="step1" class="p-4 max-w-md mx-auto">
    <!-- ‡πÉ‡∏ä‡πâ Flatpickr ‡πÄ‡∏õ‡πá‡∏ô Date Range Picker -->
    <div class="bg-slate-200 rounded-lg p-4 my-2 shadow-sm">
    <label class="text-sm text-gray-500 block mb-1 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</label>
    <div class="bg-white rounded-full px-4 py-2 mb-2 shadow-sm">
      <input type="text" id="step1DateRange" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..." class="w-full text-sm text-center focus:outline-none" />
    </div> </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á -->
    <div id="step1RoomList" class="flex flex-col"></div>
  </div>

  <!-- STEP 2: ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á (Detail) -->
  <div id="step2" class="hidden p-4 max-w-md mx-auto">
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö -->
    <button id="backToStep1" class="text-sm text-blue-500 mb-2 flex items-center space-x-1">
      <span>&larr;</span><span>‡∏Å‡∏•‡∏±‡∏ö</span>
    </button>
    <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á -->
    <div class="bg-white rounded shadow p-4">
      <!-- ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å -->
      <img id="detailMainImg" src="" alt="Room" class="w-full h-48 object-cover rounded mb-4" />
      <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á + ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà + ‡∏£‡∏≤‡∏Ñ‡∏≤ + ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≠‡∏á -->
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 id="detailRoomName" class="font-bold text-base md:text-lg leading-tight"></h2>
          <p id="detailRoomCategory" class="text-sm text-gray-500"></p>
        </div>
        <div class="text-right">
          <div id="detailRoomPrice" class="text-red-500 font-bold text-base md:text-lg"></div>
          <button id="detailBookBtn" class="mt-2 bg-black text-white text-sm py-1 px-3 rounded">
            ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
          </button>
        </div>
      </div>
      <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÅ‡∏≠‡∏£‡πå, ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ, ‡∏™‡∏£‡∏∞‡∏ô‡πâ‡∏≥, ‡∏ß‡∏¥‡∏ß) -->
      <div id="detailFeatures" class="text-xs text-gray-500 mb-3"></div>
      <!-- ‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡∏£‡∏π‡∏õ‡∏¢‡πà‡∏≠‡∏¢ -->
      <div id="detailGallery" class="flex space-x-2 overflow-x-auto mb-4"></div>
      <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
      <div id="detailRoomDesc" class="text-sm text-gray-700 mb-2"></div>
      <div id="detailRoomDesc2" class="text-sm text-gray-700 mb-2"></div>
      <!-- ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á) -->
      <div id="reviewSection" class="mt-4">
        <h3 class="font-bold mb-2">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div class="space-y-2 text-sm">
          <div class="p-2 bg-gray-50 rounded">
            <div class="font-semibold">‡∏Ñ‡∏∏‡∏ì kamin</div>
            <div>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</div>
            <div class="text-right font-bold">5</div>
          </div>
          <div class="p-2 bg-gray-50 rounded">
            <div class="font-semibold">‡∏Ñ‡∏∏‡∏ì ‡∏≠‡∏•‡∏¥‡∏™</div>
            <div>‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å</div>
            <div class="text-right font-bold">4.5</div>
          </div>
          <div class="p-2 bg-gray-50 rounded">
            <div class="font-semibold">‡∏Ñ‡∏∏‡∏ì ‡∏™‡∏°‡∏´‡∏ß‡∏±‡∏á</div>
            <div>‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏°‡∏≤‡∏≠‡∏µ‡∏Å</div>
            <div class="text-right font-bold">5</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 3: ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á (Booking) -->
  <div id="step3" class="hidden p-4 max-w-md mx-auto">
    <button id="backToStep2" class="text-sm text-blue-500 mb-2 flex items-center space-x-1">
      <span>&larr;</span><span>‡∏Å‡∏•‡∏±‡∏ö</span>
    </button>
    <div class="bg-white p-4 rounded shadow">
      <form id="bookingForm">
        <div class="grid grid-cols-2 gap-3 mb-4">
          <div>
            <label class="block text-xs text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á</label>
            <input type="text" id="bookRoomName" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
          <div>
            <label class="block text-xs text-gray-500">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <input type="text" id="bookRoomCategory" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
          <div>
            <label class="block text-xs text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤</label>
            <input type="text" id="bookRoomPrice" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
          <div>
            <label class="block text-xs text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∑‡∏ô</label>
            <input type="text" id="bookNightCount" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
          <div>
            <label class="block text-xs text-gray-500">‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="text" id="bookCheckIn" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
          <div>
            <label class="block text-xs text-gray-500">‡∏≠‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="text" id="bookCheckOut" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</label>
          <input type="number" id="bookNumGuests" class="w-full border rounded px-2 py-1 text-sm" min="1" value="1" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</label>
          <input type="text" id="bookRenterName" class="w-full border rounded px-2 py-1 text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" required />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
          <input type="tel" id="bookPhone" class="w-full border rounded px-2 py-1 text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678" required />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
          <input type="email" id="bookEmail" class="w-full border rounded px-2 py-1 text-sm" placeholder="example@gmail.com" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <textarea id="bookNote" class="w-full border rounded px-2 py-1 text-sm" rows="3"></textarea>
        </div>
        <!-- ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö userLineId (required ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ LIFF) -->
        <input type="hidden" id="bookUserLineId" required />
        <button type="button" id="submitBookingBtn" class="bg-black text-white w-full py-2 rounded text-sm">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
        </button>
      </form>
    </div>
  </div>

  <script>
    // Global state
    let roomsData = [];
    let selectedRoom = null;
    let selectedCheckIn = "";
    let selectedCheckOut = "";
    let userLineIdGlobal = "";

    // LIFF initialization (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
    async function initLiffGlobal() {
      try {
        await liff.init({ liffId: "2007106715-87nBmwNL" });
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          const profile = await liff.getProfile();
          userLineIdGlobal = profile.userId;
          const hiddenField = document.getElementById("bookUserLineId");
          if (hiddenField) {
            hiddenField.value = profile.userId;
          }
        }
      } catch (err) {
        console.error("LIFF init error:", err);
      }
    }
    document.addEventListener("DOMContentLoaded", initLiffGlobal);

    // Utility: ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (DD-MM-YYYY) ‡πÄ‡∏õ‡πá‡∏ô Date object
    function parseDateDMY(dateStr) {
      const parts = dateStr.split("-");
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    // Utility: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∑‡∏ô
    function calculateNights(checkIn, checkOut) {
      if (!checkIn || !checkOut) return "";
      const start = parseDateDMY(checkIn);
      const end = parseDateDMY(checkOut);
      if (end <= start) return "0";
      const diff = end - start;
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    // Loading Overlay functions
    function showLoading() {
      document.getElementById("loadingOverlay").classList.remove("hidden");
    }
    function hideLoading() {
      document.getElementById("loadingOverlay").classList.add("hidden");
    }

    // STEP 1: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á
    async function fetchAllRooms() {
      showLoading();
      try {
        const response = await fetch(API_URL);
        const data = await response.json();
        if (!Array.isArray(data)) {
          console.error("Data received is not an array:", data);
          return;
        }
        roomsData = data;
        renderRoomList(data, false);
      } catch (err) {
        console.error("Error fetching rooms:", err);
      } finally {
        hideLoading();
      }
    }
    async function fetchRooms(checkIn, checkOut) {
      showLoading();
      try {
        const response = await fetch(`${API_URL}?checkIn=${checkIn}&checkOut=${checkOut}`);
        const data = await response.json();
        if (!Array.isArray(data)) {
          console.error("Data received is not an array:", data);
          return;
        }
        roomsData = data;
        renderRoomList(data, true);
      } catch (err) {
        console.error("Error fetching rooms:", err);
      } finally {
        hideLoading();
      }
    }

    /**
     * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderRoomList
     */
    function renderRoomList(rooms, isStatusCalculated) {
      const container = document.getElementById("step1RoomList");
      container.innerHTML = "";

      if (!Array.isArray(rooms)) {
        console.error("Expected rooms to be an array, but got:", rooms);
        container.innerHTML = "<p class='text-gray-500'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡πÑ‡∏î‡πâ</p>";
        return;
      }
      if (rooms.length === 0) {
        container.innerHTML = "<p class='text-gray-500'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>";
        return;
      }

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)
      if (isStatusCalculated) {
        rooms.sort((a, b) => {
          const sA = a["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"] ? a["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"].toLowerCase() : "";
          const sB = b["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"] ? b["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"].toLowerCase() : "";
          if (sA === "‡∏ß‡πà‡∏≤‡∏á" && sB === "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á") return -1;
          if (sA === "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á" && sB === "‡∏ß‡πà‡∏≤‡∏á") return 1;
          return 0;
        });
      }

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const dateRange = document.getElementById("step1DateRange").value;
      let checkInDateValue = "";
      let checkOutDateValue = "";
      if (dateRange && dateRange.includes(" to ")) {
        const parts = dateRange.split(" to ");
        checkInDateValue = parts[0].trim();
        checkOutDateValue = parts[1].trim();
      }

      // ‡πÅ‡∏¢‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏ß‡∏î "popular" ‡πÅ‡∏•‡∏∞ "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
      const popularRooms = rooms.filter(room => room["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"] && room["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"].toLowerCase() === "popular");
      const otherRooms = rooms.filter(room => !room["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"] || room["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"].toLowerCase() !== "popular");

      // ‡∏™‡πà‡∏ß‡∏ô popular
      if (popularRooms.length > 0) {
        const headingPopular = document.createElement("h3");
        headingPopular.className = "text-md font-bold mb-2";
        headingPopular.textContent = "‚≠ê POPULAR";
        container.appendChild(headingPopular);

        const poppularContainer = document.createElement("div");
        poppularContainer.className = "flex space-x-4 overflow-x-auto pb-4";
        container.appendChild(poppularContainer);

        popularRooms.forEach((room) => {
          let statusText = "";
          let statusColor = "";
          if (isStatusCalculated) {
            if (room["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"] && room["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"].toLowerCase() === "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á") {
              statusText = "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á";
              statusColor = "bg-red-500";
            } else {
              statusText = "‡∏ß‡πà‡∏≤‡∏á";
              statusColor = "bg-green-500";
            }
          }
          const card = document.createElement("div");
          card.className = "relative w-48 h-40 rounded-lg overflow-hidden shadow flex-shrink-0";
          const bgImg = document.createElement("img");
          bgImg.src = room["‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"];
          bgImg.alt = room["‡∏ä‡∏∑‡πà‡∏≠"] || "Room";
          bgImg.className = "absolute inset-0 w-full h-full object-cover";
          card.appendChild(bgImg);
          const gradientOverlay = document.createElement("div");
          gradientOverlay.className = "absolute inset-x-0 bottom-0 h-16 bg-gradient-to-t from-black/60 to-transparent";
          card.appendChild(gradientOverlay);
          if (statusText) {
            const statusBadge = document.createElement("div");
            statusBadge.className = `absolute top-2 right-2 px-2 py-1 text-white text-xs rounded ${statusColor}`;
            statusBadge.textContent = statusText;
            card.appendChild(statusBadge);
          }
          const infoDiv = document.createElement("div");
          infoDiv.className = "absolute bottom-2 left-2 text-white";
          const title = document.createElement("div");
          title.className = "font-semibold text-sm";
          title.textContent = room["‡∏ä‡∏∑‡πà‡∏≠"] || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠";
          infoDiv.appendChild(title);
          const price = document.createElement("div");
          price.className = "text-sm";
          if (room["‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡∏î"]) {
            price.innerHTML = `<span class="line-through text-gray-200 mr-1">${room["‡∏£‡∏≤‡∏Ñ‡∏≤"]}</span>
                                <span class="font-bold">${room["‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡∏î"]}</span>`;
          } else {
            price.textContent = room["‡∏£‡∏≤‡∏Ñ‡∏≤"] || "0";
          }
          infoDiv.appendChild(price);
          card.appendChild(infoDiv);
          const selectBtn = document.createElement("button");
          selectBtn.className = "absolute bottom-2 right-2 bg-blue-500 text-white text-xs px-3 py-1 rounded-full shadow";
          selectBtn.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
          selectBtn.addEventListener("click", (e) => {
            e.preventDefault();
            selectedRoom = room;
            selectedCheckIn = checkInDateValue;
            selectedCheckOut = checkOutDateValue;
            showStep("step2");
            populateDetail();
          });
          card.appendChild(selectBtn);
          poppularContainer.appendChild(card);
        });
      }

      // ‡∏™‡πà‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ
      if (otherRooms.length > 0) {
        const headingOthers = document.createElement("h3");
        headingOthers.className = "text-md font-bold mb-2";
        headingOthers.textContent = "üè† ROOM";
        container.appendChild(headingOthers);

        otherRooms.forEach((room) => {
          let statusText = "";
          let statusColor = "";
          if (isStatusCalculated) {
            if (room["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"] && room["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"].toLowerCase() === "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á") {
              statusText = "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á";
              statusColor = "bg-red-500";
            } else {
              statusText = "‡∏ß‡πà‡∏≤‡∏á";
              statusColor = "bg-green-500";
            }
          }
          const row = document.createElement("div");
          row.className = "bg-white rounded-lg shadow p-2 flex items-center mb-3";
          const imgWrapper = document.createElement("div");
          imgWrapper.className = "w-24 h-16 overflow-hidden rounded";
          const img = document.createElement("img");
          img.src = room["‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"];
          img.alt = room["‡∏ä‡∏∑‡πà‡∏≠"];
          img.className = "w-full h-full object-cover";
          imgWrapper.appendChild(img);
          row.appendChild(imgWrapper);
          const middleDiv = document.createElement("div");
          middleDiv.className = "flex-1 px-3";
          const title = document.createElement("div");
          title.className = "font-bold text-sm";
          title.textContent = room["‡∏ä‡∏∑‡πà‡∏≠"] || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠";
          middleDiv.appendChild(title);
          const category = document.createElement("div");
          category.className = "text-xs text-gray-500";
          category.textContent = room["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"] || "";
          middleDiv.appendChild(category);
          const priceLine = document.createElement("div");
          priceLine.className = "text-sm mt-1";
          if (room["‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡∏î"]) {
            priceLine.innerHTML = `<span class="text-gray-400 line-through mr-2 text-xs">${room["‡∏£‡∏≤‡∏Ñ‡∏≤"]}</span>
                                   <span class="text-red-500 font-bold">${room["‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡∏î"]}</span>`;
          } else {
            priceLine.innerHTML = `<span class="text-red-500 font-bold">${room["‡∏£‡∏≤‡∏Ñ‡∏≤"] || "0"}</span>`;
          }
          middleDiv.appendChild(priceLine);
          row.appendChild(middleDiv);
          const rightDiv = document.createElement("div");
          rightDiv.className = "flex flex-col items-end space-y-1";
          if (statusText) {
            const statusBtn = document.createElement("button");
            statusBtn.className = "text-white text-xs px-3 py-1 rounded-full";
            statusBtn.textContent = statusText;
            statusBtn.classList.add(statusColor);
            rightDiv.appendChild(statusBtn);
          }
          const btnSelect = document.createElement("button");
          btnSelect.className = "bg-black text-white text-xs px-3 py-1 rounded-full";
          btnSelect.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
          btnSelect.addEventListener("click", (e) => {
            e.preventDefault();
            selectedRoom = room;
            selectedCheckIn = checkInDateValue;
            selectedCheckOut = checkOutDateValue;
            showStep("step2");
            populateDetail();
          });
          rightDiv.appendChild(btnSelect);
          row.appendChild(rightDiv);
          container.appendChild(row);
        });
      }
    }

    // STEP 2: ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á
    function populateDetail() {
      if (!selectedRoom) return;
      document.getElementById("detailRoomName").textContent = selectedRoom["‡∏ä‡∏∑‡πà‡∏≠"] || "";
      document.getElementById("detailRoomCategory").textContent = selectedRoom["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"] ? `(${selectedRoom["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"]})` : "";
      document.getElementById("detailRoomPrice").textContent = selectedRoom["‡∏£‡∏≤‡∏Ñ‡∏≤"] || "0";
      const mainImgElement = document.getElementById("detailMainImg");
      mainImgElement.src = selectedRoom["‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"] || "";
      mainImgElement.alt = selectedRoom["‡∏ä‡∏∑‡πà‡∏≠"] || "Room";
      const features = [];
      if (String(selectedRoom["‡πÅ‡∏≠‡∏£‡πå"]).toLowerCase() === "true")
        features.push("‡πÅ‡∏≠‡∏£‡πå");
      if (String(selectedRoom["‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ"]).toLowerCase() === "true")
        features.push("‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ");
      if (String(selectedRoom["‡∏™‡∏£‡∏∞‡∏ô‡πâ‡∏≥"]).toLowerCase() === "true")
        features.push("‡∏™‡∏£‡∏∞‡∏ô‡πâ‡∏≥");
      if (String(selectedRoom["‡∏ß‡∏¥‡∏ß"]).toLowerCase() === "true")
        features.push("‡∏ß‡∏¥‡∏ß");
      document.getElementById("detailFeatures").textContent = features.join(" ‚Ä¢ ");
      const galleryContainer = document.getElementById("detailGallery");
      galleryContainer.innerHTML = "";
      for (let i = 1; i <= 4; i++) {
        const key = `‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö-${i}`;
        if (selectedRoom[key]) {
          const img = document.createElement("img");
          img.src = selectedRoom[key];
          img.alt = key;
          img.className = "w-20 h-20 object-cover rounded cursor-pointer";
          img.addEventListener("click", () => {
            mainImgElement.src = selectedRoom[key];
            mainImgElement.alt = key;
          });
          galleryContainer.appendChild(img);
        }
      }
      document.getElementById("detailRoomDesc").textContent = selectedRoom["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"] || "";
      document.getElementById("detailRoomDesc2").textContent = selectedRoom["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î-2"] || "";
      const bookingBtn = document.getElementById("detailBookBtn");
      if (!selectedCheckIn || !selectedCheckOut) {
        bookingBtn.disabled = true;
        bookingBtn.classList.add("opacity-50", "cursor-not-allowed");
        bookingBtn.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô";
      } else if (selectedRoom["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"] && selectedRoom["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"].toLowerCase() === "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á") {
        bookingBtn.disabled = true;
        bookingBtn.classList.add("opacity-50", "cursor-not-allowed");
        bookingBtn.textContent = "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á";
      } else {
        bookingBtn.disabled = false;
        bookingBtn.classList.remove("opacity-50", "cursor-not-allowed");
        bookingBtn.textContent = "‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ";
        bookingBtn.onclick = () => {
          showStep("step3");
          populateBookingForm();
        };
      }
    }

    // STEP 3: ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á
    function populateBookingForm() {
      document.getElementById("bookRoomName").value = selectedRoom["‡∏ä‡∏∑‡πà‡∏≠"] || "";
      document.getElementById("bookRoomCategory").value = selectedRoom["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"] || "";
      document.getElementById("bookRoomPrice").value = selectedRoom["‡∏£‡∏≤‡∏Ñ‡∏≤"] || "";
      document.getElementById("bookCheckIn").value = selectedCheckIn;
      document.getElementById("bookCheckOut").value = selectedCheckOut;
      const nights = calculateNights(selectedCheckIn, selectedCheckOut);
      document.getElementById("bookNightCount").value = nights + " ‡∏Ñ‡∏∑‡∏ô";
    }

    function showStep(stepId) {
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("step2").classList.add("hidden");
      document.getElementById("step3").classList.add("hidden");
      document.getElementById(stepId).classList.remove("hidden");
    }

    document.getElementById("backToStep1").addEventListener("click", () => {
      showStep("step1");
    });
    document.getElementById("backToStep2").addEventListener("click", () => {
      showStep("step2");
    });

    function updateRooms() {
      const dateRange = document.getElementById("step1DateRange").value;
      let checkIn = "";
      let checkOut = "";
      if (dateRange && dateRange.includes(" to ")) {
        const parts = dateRange.split(" to ");
        checkIn = parts[0].trim();
        checkOut = parts[1].trim();
      }
      if (checkIn && checkOut) {
        fetchRooms(checkIn, checkOut);
      } else {
        fetchAllRooms();
      }
    }
    document.getElementById("step1DateRange").addEventListener("change", updateRooms);

    document.addEventListener("DOMContentLoaded", () => {
      flatpickr("#step1DateRange", {
        mode: "range",
        dateFormat: "d-m-Y",
        onClose: updateRooms,
      });
      fetchAllRooms();
    });

    // Submit booking form with required field validation
    document.getElementById("submitBookingBtn").addEventListener("click", () => {
      const btn = document.getElementById("submitBookingBtn");
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå required
      const renterName = document.getElementById("bookRenterName").value.trim();
      const phone = document.getElementById("bookPhone").value.trim();
      const userLineId = document.getElementById("bookUserLineId").value.trim();
      if (!renterName || !phone || !userLineId) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
        return;
      }
      
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥: disable ‡∏õ‡∏∏‡πà‡∏° ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      btn.disabled = true;
      btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
      showLoading();
      
      const bookingData = {
        roomName: document.getElementById("bookRoomName").value,
        roomCategory: document.getElementById("bookRoomCategory").value,
        roomPrice: document.getElementById("bookRoomPrice").value,
        checkIn: document.getElementById("bookCheckIn").value,
        checkOut: document.getElementById("bookCheckOut").value,
        numGuests: document.getElementById("bookNumGuests").value,
        renterName: renterName,
        phone: phone,
        email: document.getElementById("bookEmail").value,
        note: document.getElementById("bookNote").value,
        userLineId: userLineId,
      };
      
      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(bookingData),
      })
      .then((response) => response.text())
      .then((data) => {
        console.log(data);
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        hideLoading();
        // ‡∏õ‡∏¥‡∏î LIFF ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥
        if (liff && liff.close) {
          liff.close();
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        hideLoading();
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        btn.disabled = false;
        btn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
      });
    });
  </script>
</body>
</html>
