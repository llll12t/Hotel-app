<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>โอมสเตย์</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include Flatpickr CSS and JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Include config.js สำหรับ API_URL -->
  <script src="config.js"></script>
  <!-- LIFF SDK (หากต้องการใช้งาน ให้ uncomment และตั้งค่า liff.init) -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <!-- Custom CSS for loading spinner -->
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 64px;
      height: 64px;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen relative">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
    <div class="loader"></div>
  </div>

  <!-- STEP 1: เลือกห้อง (Index) -->
  <div id="step1" class="p-4 max-w-md mx-auto">
    <!-- ใช้ Flatpickr เป็น Date Range Picker -->
    <div class="bg-slate-200 rounded-lg p-4 my-2 shadow-sm">
    <label class="text-sm text-gray-500 block mb-1 text-center">เลือกวันที่เข้าพักและวันที่ออก</label>
    <div class="bg-white rounded-full px-4 py-2 mb-2 shadow-sm">
      <input type="text" id="step1DateRange" placeholder="เลือกวันที่..." class="w-full text-sm text-center focus:outline-none" />
    </div> </div>

    <!-- รายการห้อง -->
    <div id="step1RoomList" class="flex flex-col"></div>
  </div>

  <!-- STEP 2: ดูรายละเอียดห้อง (Detail) -->
  <div id="step2" class="hidden p-4 max-w-md mx-auto">
    <!-- ปุ่มกลับ -->
    <button id="backToStep1" class="text-sm text-blue-500 mb-2 flex items-center space-x-1">
      <span>&larr;</span><span>กลับ</span>
    </button>
    <!-- กล่องรายละเอียดห้อง -->
    <div class="bg-white rounded shadow p-4">
      <!-- รูปหลัก -->
      <img id="detailMainImg" src="" alt="Room" class="w-full h-48 object-cover rounded mb-4" />
      <!-- ส่วนชื่อห้อง + หมวดหมู่ + ราคา + ปุ่มจอง -->
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 id="detailRoomName" class="font-bold text-base md:text-lg leading-tight"></h2>
          <p id="detailRoomCategory" class="text-sm text-gray-500"></p>
        </div>
        <div class="text-right">
          <div id="detailRoomPrice" class="text-red-500 font-bold text-base md:text-lg"></div>
          <button id="detailBookBtn" class="mt-2 bg-black text-white text-sm py-1 px-3 rounded">
            จองห้องนี้
          </button>
        </div>
      </div>
      <!-- แสดงฟีเจอร์เพิ่มเติม (แอร์, ที่จอดรถ, สระน้ำ, วิว) -->
      <div id="detailFeatures" class="text-xs text-gray-500 mb-3"></div>
      <!-- แกลเลอรีรูปย่อย -->
      <div id="detailGallery" class="flex space-x-2 overflow-x-auto mb-4"></div>
      <!-- รายละเอียดเพิ่มเติม -->
      <div id="detailRoomDesc" class="text-sm text-gray-700 mb-2"></div>
      <div id="detailRoomDesc2" class="text-sm text-gray-700 mb-2"></div>
      <!-- รีวิวล่าสุด (ตัวอย่าง) -->
      <div id="reviewSection" class="mt-4">
        <h3 class="font-bold mb-2">รีวิวล่าสุด</h3>
        <div class="space-y-2 text-sm">
          <div class="p-2 bg-gray-50 rounded">
            <div class="font-semibold">คุณ kamin</div>
            <div>ห้องพักสะอาดมากเลยครับ</div>
            <div class="text-right font-bold">5</div>
          </div>
          <div class="p-2 bg-gray-50 rounded">
            <div class="font-semibold">คุณ อลิส</div>
            <div>เยี่ยมมาก</div>
            <div class="text-right font-bold">4.5</div>
          </div>
          <div class="p-2 bg-gray-50 rounded">
            <div class="font-semibold">คุณ สมหวัง</div>
            <div>แล้วจะมาอีก</div>
            <div class="text-right font-bold">5</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 3: ฟอร์มจอง (Booking) -->
  <div id="step3" class="hidden p-4 max-w-md mx-auto">
    <button id="backToStep2" class="text-sm text-blue-500 mb-2 flex items-center space-x-1">
      <span>&larr;</span><span>กลับ</span>
    </button>
    <div class="bg-white p-4 rounded shadow">
      <form id="bookingForm">
        <div class="grid grid-cols-2 gap-3 mb-4">
          <div>
            <label class="block text-xs text-gray-500">ชื่อห้อง</label>
            <input type="text" id="bookRoomName" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
          <div>
            <label class="block text-xs text-gray-500">หมวดหมู่</label>
            <input type="text" id="bookRoomCategory" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
          <div>
            <label class="block text-xs text-gray-500">ราคา</label>
            <input type="text" id="bookRoomPrice" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
          <div>
            <label class="block text-xs text-gray-500">จำนวนคืน</label>
            <input type="text" id="bookNightCount" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
          <div>
            <label class="block text-xs text-gray-500">เข้าพักวันที่</label>
            <input type="text" id="bookCheckIn" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
          <div>
            <label class="block text-xs text-gray-500">ออกวันที่</label>
            <input type="text" id="bookCheckOut" class="w-full border-b border-gray-300 bg-white text-sm font-semibold py-1" readonly />
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-1">จำนวนคนเข้าพัก</label>
          <input type="number" id="bookNumGuests" class="w-full border rounded px-2 py-1 text-sm" min="1" value="1" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-1">ชื่อผู้เช่า</label>
          <input type="text" id="bookRenterName" class="w-full border rounded px-2 py-1 text-sm" placeholder="เช่น สมชาย ใจดี" required />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-1">เบอร์ติดต่อ</label>
          <input type="tel" id="bookPhone" class="w-full border rounded px-2 py-1 text-sm" placeholder="เช่น 0812345678" required />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-1">อีเมล</label>
          <input type="email" id="bookEmail" class="w-full border rounded px-2 py-1 text-sm" placeholder="example@gmail.com" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-1">หมายเหตุ</label>
          <textarea id="bookNote" class="w-full border rounded px-2 py-1 text-sm" rows="3"></textarea>
        </div>
        <!-- ฟิลด์ซ่อนสำหรับเก็บ userLineId (required เมื่อใช้ LIFF) -->
        <input type="hidden" id="bookUserLineId" required />
        <button type="button" id="submitBookingBtn" class="bg-black text-white w-full py-2 rounded text-sm">
          บันทึกการจอง
        </button>
      </form>
    </div>
  </div>

  <script>
    // Global state
    let roomsData = [];
    let selectedRoom = null;
    let selectedCheckIn = "";
    let selectedCheckOut = "";
    let userLineIdGlobal = "";

    // LIFF initialization (ถ้าต้องการ)
    async function initLiffGlobal() {
      try {
        await liff.init({ liffId: "2007106715-87nBmwNL" });
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          const profile = await liff.getProfile();
          userLineIdGlobal = profile.userId;
          const hiddenField = document.getElementById("bookUserLineId");
          if (hiddenField) {
            hiddenField.value = profile.userId;
          }
        }
      } catch (err) {
        console.error("LIFF init error:", err);
      }
    }
    document.addEventListener("DOMContentLoaded", initLiffGlobal);

    // Utility: แปลงวันที่ (DD-MM-YYYY) เป็น Date object
    function parseDateDMY(dateStr) {
      const parts = dateStr.split("-");
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    // Utility: คำนวณจำนวนคืน
    function calculateNights(checkIn, checkOut) {
      if (!checkIn || !checkOut) return "";
      const start = parseDateDMY(checkIn);
      const end = parseDateDMY(checkOut);
      if (end <= start) return "0";
      const diff = end - start;
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    // Loading Overlay functions
    function showLoading() {
      document.getElementById("loadingOverlay").classList.remove("hidden");
    }
    function hideLoading() {
      document.getElementById("loadingOverlay").classList.add("hidden");
    }

    // STEP 1: ดึงรายการห้อง
    async function fetchAllRooms() {
      showLoading();
      try {
        const response = await fetch(API_URL);
        const data = await response.json();
        if (!Array.isArray(data)) {
          console.error("Data received is not an array:", data);
          return;
        }
        roomsData = data;
        renderRoomList(data, false);
      } catch (err) {
        console.error("Error fetching rooms:", err);
      } finally {
        hideLoading();
      }
    }
    async function fetchRooms(checkIn, checkOut) {
      showLoading();
      try {
        const response = await fetch(`${API_URL}?checkIn=${checkIn}&checkOut=${checkOut}`);
        const data = await response.json();
        if (!Array.isArray(data)) {
          console.error("Data received is not an array:", data);
          return;
        }
        roomsData = data;
        renderRoomList(data, true);
      } catch (err) {
        console.error("Error fetching rooms:", err);
      } finally {
        hideLoading();
      }
    }

    /**
     * ฟังก์ชัน renderRoomList
     */
    function renderRoomList(rooms, isStatusCalculated) {
      const container = document.getElementById("step1RoomList");
      container.innerHTML = "";

      if (!Array.isArray(rooms)) {
        console.error("Expected rooms to be an array, but got:", rooms);
        container.innerHTML = "<p class='text-gray-500'>ไม่สามารถดึงข้อมูลห้องพักได้</p>";
        return;
      }
      if (rooms.length === 0) {
        container.innerHTML = "<p class='text-gray-500'>ไม่มีห้องที่ตรงกับการค้นหา</p>";
        return;
      }

      // เรียงห้องตามสถานะ (ถ้ามีการคำนวณ)
      if (isStatusCalculated) {
        rooms.sort((a, b) => {
          const sA = a["สถานะ"] ? a["สถานะ"].toLowerCase() : "";
          const sB = b["สถานะ"] ? b["สถานะ"].toLowerCase() : "";
          if (sA === "ว่าง" && sB === "ไม่ว่าง") return -1;
          if (sA === "ไม่ว่าง" && sB === "ว่าง") return 1;
          return 0;
        });
      }

      // เก็บวันที่ที่ผู้ใช้เลือก
      const dateRange = document.getElementById("step1DateRange").value;
      let checkInDateValue = "";
      let checkOutDateValue = "";
      if (dateRange && dateRange.includes(" to ")) {
        const parts = dateRange.split(" to ");
        checkInDateValue = parts[0].trim();
        checkOutDateValue = parts[1].trim();
      }

      // แยกห้องเป็นหมวด "popular" และ "อื่นๆ"
      const popularRooms = rooms.filter(room => room["หมวดหมู่"] && room["หมวดหมู่"].toLowerCase() === "popular");
      const otherRooms = rooms.filter(room => !room["หมวดหมู่"] || room["หมวดหมู่"].toLowerCase() !== "popular");

      // ส่วน popular
      if (popularRooms.length > 0) {
        const headingPopular = document.createElement("h3");
        headingPopular.className = "text-md font-bold mb-2";
        headingPopular.textContent = "⭐ POPULAR";
        container.appendChild(headingPopular);

        const poppularContainer = document.createElement("div");
        poppularContainer.className = "flex space-x-4 overflow-x-auto pb-4";
        container.appendChild(poppularContainer);

        popularRooms.forEach((room) => {
          let statusText = "";
          let statusColor = "";
          if (isStatusCalculated) {
            if (room["สถานะ"] && room["สถานะ"].toLowerCase() === "ไม่ว่าง") {
              statusText = "ไม่ว่าง";
              statusColor = "bg-red-500";
            } else {
              statusText = "ว่าง";
              statusColor = "bg-green-500";
            }
          }
          const card = document.createElement("div");
          card.className = "relative w-48 h-40 rounded-lg overflow-hidden shadow flex-shrink-0";
          const bgImg = document.createElement("img");
          bgImg.src = room["รูปภาพ"];
          bgImg.alt = room["ชื่อ"] || "Room";
          bgImg.className = "absolute inset-0 w-full h-full object-cover";
          card.appendChild(bgImg);
          const gradientOverlay = document.createElement("div");
          gradientOverlay.className = "absolute inset-x-0 bottom-0 h-16 bg-gradient-to-t from-black/60 to-transparent";
          card.appendChild(gradientOverlay);
          if (statusText) {
            const statusBadge = document.createElement("div");
            statusBadge.className = `absolute top-2 right-2 px-2 py-1 text-white text-xs rounded ${statusColor}`;
            statusBadge.textContent = statusText;
            card.appendChild(statusBadge);
          }
          const infoDiv = document.createElement("div");
          infoDiv.className = "absolute bottom-2 left-2 text-white";
          const title = document.createElement("div");
          title.className = "font-semibold text-sm";
          title.textContent = room["ชื่อ"] || "ไม่มีชื่อ";
          infoDiv.appendChild(title);
          const price = document.createElement("div");
          price.className = "text-sm";
          if (room["ราคาลด"]) {
            price.innerHTML = `<span class="line-through text-gray-200 mr-1">${room["ราคา"]}</span>
                                <span class="font-bold">${room["ราคาลด"]}</span>`;
          } else {
            price.textContent = room["ราคา"] || "0";
          }
          infoDiv.appendChild(price);
          card.appendChild(infoDiv);
          const selectBtn = document.createElement("button");
          selectBtn.className = "absolute bottom-2 right-2 bg-blue-500 text-white text-xs px-3 py-1 rounded-full shadow";
          selectBtn.textContent = "เลือก";
          selectBtn.addEventListener("click", (e) => {
            e.preventDefault();
            selectedRoom = room;
            selectedCheckIn = checkInDateValue;
            selectedCheckOut = checkOutDateValue;
            showStep("step2");
            populateDetail();
          });
          card.appendChild(selectBtn);
          poppularContainer.appendChild(card);
        });
      }

      // ส่วนห้องอื่นๆ
      if (otherRooms.length > 0) {
        const headingOthers = document.createElement("h3");
        headingOthers.className = "text-md font-bold mb-2";
        headingOthers.textContent = "🏠 ROOM";
        container.appendChild(headingOthers);

        otherRooms.forEach((room) => {
          let statusText = "";
          let statusColor = "";
          if (isStatusCalculated) {
            if (room["สถานะ"] && room["สถานะ"].toLowerCase() === "ไม่ว่าง") {
              statusText = "ไม่ว่าง";
              statusColor = "bg-red-500";
            } else {
              statusText = "ว่าง";
              statusColor = "bg-green-500";
            }
          }
          const row = document.createElement("div");
          row.className = "bg-white rounded-lg shadow p-2 flex items-center mb-3";
          const imgWrapper = document.createElement("div");
          imgWrapper.className = "w-24 h-16 overflow-hidden rounded";
          const img = document.createElement("img");
          img.src = room["รูปภาพ"];
          img.alt = room["ชื่อ"];
          img.className = "w-full h-full object-cover";
          imgWrapper.appendChild(img);
          row.appendChild(imgWrapper);
          const middleDiv = document.createElement("div");
          middleDiv.className = "flex-1 px-3";
          const title = document.createElement("div");
          title.className = "font-bold text-sm";
          title.textContent = room["ชื่อ"] || "ไม่มีชื่อ";
          middleDiv.appendChild(title);
          const category = document.createElement("div");
          category.className = "text-xs text-gray-500";
          category.textContent = room["หมวดหมู่"] || "";
          middleDiv.appendChild(category);
          const priceLine = document.createElement("div");
          priceLine.className = "text-sm mt-1";
          if (room["ราคาลด"]) {
            priceLine.innerHTML = `<span class="text-gray-400 line-through mr-2 text-xs">${room["ราคา"]}</span>
                                   <span class="text-red-500 font-bold">${room["ราคาลด"]}</span>`;
          } else {
            priceLine.innerHTML = `<span class="text-red-500 font-bold">${room["ราคา"] || "0"}</span>`;
          }
          middleDiv.appendChild(priceLine);
          row.appendChild(middleDiv);
          const rightDiv = document.createElement("div");
          rightDiv.className = "flex flex-col items-end space-y-1";
          if (statusText) {
            const statusBtn = document.createElement("button");
            statusBtn.className = "text-white text-xs px-3 py-1 rounded-full";
            statusBtn.textContent = statusText;
            statusBtn.classList.add(statusColor);
            rightDiv.appendChild(statusBtn);
          }
          const btnSelect = document.createElement("button");
          btnSelect.className = "bg-black text-white text-xs px-3 py-1 rounded-full";
          btnSelect.textContent = "เลือก";
          btnSelect.addEventListener("click", (e) => {
            e.preventDefault();
            selectedRoom = room;
            selectedCheckIn = checkInDateValue;
            selectedCheckOut = checkOutDateValue;
            showStep("step2");
            populateDetail();
          });
          rightDiv.appendChild(btnSelect);
          row.appendChild(rightDiv);
          container.appendChild(row);
        });
      }
    }

    // STEP 2: หน้าแสดงรายละเอียดห้อง
    function populateDetail() {
      if (!selectedRoom) return;
      document.getElementById("detailRoomName").textContent = selectedRoom["ชื่อ"] || "";
      document.getElementById("detailRoomCategory").textContent = selectedRoom["หมวดหมู่"] ? `(${selectedRoom["หมวดหมู่"]})` : "";
      document.getElementById("detailRoomPrice").textContent = selectedRoom["ราคา"] || "0";
      const mainImgElement = document.getElementById("detailMainImg");
      mainImgElement.src = selectedRoom["รูปภาพ"] || "";
      mainImgElement.alt = selectedRoom["ชื่อ"] || "Room";
      const features = [];
      if (String(selectedRoom["แอร์"]).toLowerCase() === "true")
        features.push("แอร์");
      if (String(selectedRoom["ที่จอดรถ"]).toLowerCase() === "true")
        features.push("ที่จอดรถ");
      if (String(selectedRoom["สระน้ำ"]).toLowerCase() === "true")
        features.push("สระน้ำ");
      if (String(selectedRoom["วิว"]).toLowerCase() === "true")
        features.push("วิว");
      document.getElementById("detailFeatures").textContent = features.join(" • ");
      const galleryContainer = document.getElementById("detailGallery");
      galleryContainer.innerHTML = "";
      for (let i = 1; i <= 4; i++) {
        const key = `รูปประกอบ-${i}`;
        if (selectedRoom[key]) {
          const img = document.createElement("img");
          img.src = selectedRoom[key];
          img.alt = key;
          img.className = "w-20 h-20 object-cover rounded cursor-pointer";
          img.addEventListener("click", () => {
            mainImgElement.src = selectedRoom[key];
            mainImgElement.alt = key;
          });
          galleryContainer.appendChild(img);
        }
      }
      document.getElementById("detailRoomDesc").textContent = selectedRoom["รายละเอียด"] || "";
      document.getElementById("detailRoomDesc2").textContent = selectedRoom["รายละเอียด-2"] || "";
      const bookingBtn = document.getElementById("detailBookBtn");
      if (!selectedCheckIn || !selectedCheckOut) {
        bookingBtn.disabled = true;
        bookingBtn.classList.add("opacity-50", "cursor-not-allowed");
        bookingBtn.textContent = "เลือกวันที่เข้าพักก่อน";
      } else if (selectedRoom["สถานะ"] && selectedRoom["สถานะ"].toLowerCase() === "ไม่ว่าง") {
        bookingBtn.disabled = true;
        bookingBtn.classList.add("opacity-50", "cursor-not-allowed");
        bookingBtn.textContent = "ไม่ว่าง";
      } else {
        bookingBtn.disabled = false;
        bookingBtn.classList.remove("opacity-50", "cursor-not-allowed");
        bookingBtn.textContent = "จองห้องนี้";
        bookingBtn.onclick = () => {
          showStep("step3");
          populateBookingForm();
        };
      }
    }

    // STEP 3: หน้าแบบฟอร์มจองห้อง
    function populateBookingForm() {
      document.getElementById("bookRoomName").value = selectedRoom["ชื่อ"] || "";
      document.getElementById("bookRoomCategory").value = selectedRoom["หมวดหมู่"] || "";
      document.getElementById("bookRoomPrice").value = selectedRoom["ราคา"] || "";
      document.getElementById("bookCheckIn").value = selectedCheckIn;
      document.getElementById("bookCheckOut").value = selectedCheckOut;
      const nights = calculateNights(selectedCheckIn, selectedCheckOut);
      document.getElementById("bookNightCount").value = nights + " คืน";
    }

    function showStep(stepId) {
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("step2").classList.add("hidden");
      document.getElementById("step3").classList.add("hidden");
      document.getElementById(stepId).classList.remove("hidden");
    }

    document.getElementById("backToStep1").addEventListener("click", () => {
      showStep("step1");
    });
    document.getElementById("backToStep2").addEventListener("click", () => {
      showStep("step2");
    });

    function updateRooms() {
      const dateRange = document.getElementById("step1DateRange").value;
      let checkIn = "";
      let checkOut = "";
      if (dateRange && dateRange.includes(" to ")) {
        const parts = dateRange.split(" to ");
        checkIn = parts[0].trim();
        checkOut = parts[1].trim();
      }
      if (checkIn && checkOut) {
        fetchRooms(checkIn, checkOut);
      } else {
        fetchAllRooms();
      }
    }
    document.getElementById("step1DateRange").addEventListener("change", updateRooms);

    document.addEventListener("DOMContentLoaded", () => {
      flatpickr("#step1DateRange", {
        mode: "range",
        dateFormat: "d-m-Y",
        onClose: updateRooms,
      });
      fetchAllRooms();
    });

    // Submit booking form with required field validation
    document.getElementById("submitBookingBtn").addEventListener("click", () => {
      const btn = document.getElementById("submitBookingBtn");
      
      // ตรวจสอบความครบถ้วนของฟิลด์ required
      const renterName = document.getElementById("bookRenterName").value.trim();
      const phone = document.getElementById("bookPhone").value.trim();
      const userLineId = document.getElementById("bookUserLineId").value.trim();
      if (!renterName || !phone || !userLineId) {
        alert("กรุณากรอกข้อมูล ชื่อผู้เช่า เบอร์ติดต่อ และข้อมูล LINE ให้ครบถ้วน");
        return;
      }
      
      // ป้องกันการกดซ้ำ: disable ปุ่ม และเปลี่ยนข้อความ
      btn.disabled = true;
      btn.textContent = "กำลังบันทึก...";
      showLoading();
      
      const bookingData = {
        roomName: document.getElementById("bookRoomName").value,
        roomCategory: document.getElementById("bookRoomCategory").value,
        roomPrice: document.getElementById("bookRoomPrice").value,
        checkIn: document.getElementById("bookCheckIn").value,
        checkOut: document.getElementById("bookCheckOut").value,
        numGuests: document.getElementById("bookNumGuests").value,
        renterName: renterName,
        phone: phone,
        email: document.getElementById("bookEmail").value,
        note: document.getElementById("bookNote").value,
        userLineId: userLineId,
      };
      
      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(bookingData),
      })
      .then((response) => response.text())
      .then((data) => {
        console.log(data);
        alert("บันทึกการจองเรียบร้อย");
        hideLoading();
        // ปิด LIFF เมื่อบันทึกสำเร็จเพื่อป้องกันการบันทึกซ้ำ
        if (liff && liff.close) {
          liff.close();
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        hideLoading();
        // กรณีเกิด error ให้เปิดใช้งานปุ่มอีกครั้ง
        btn.disabled = false;
        btn.textContent = "บันทึกการจอง";
      });
    });
  </script>
</body>
</html>
