<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HOMESTAY - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: 'Sarabun', sans-serif; }
    .nav-link.active { background-color: #e2e8f0; font-weight: 600; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen flex">

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
  </div>

  <!-- Side Navigation -->
  <aside class="w-64 bg-white shadow-lg flex flex-col flex-shrink-0">
    <div class="p-4 font-bold text-xl border-b text-center text-slate-800">
      HOMESTAY
    </div>
    <nav id="main-nav" class="flex-1 space-y-1 mt-4">
      <a href="#appointment" data-view="appointment" class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg mx-2">
        <span class="material-icons-round">book_online</span>
        <span>Booking</span>
      </a>
      <a href="#room" data-view="room" class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg mx-2">
        <span class="material-icons-round">king_bed</span>
        <span>Room</span>
      </a>
      <a href="#member" data-view="member" class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg mx-2">
        <span class="material-icons-round">group</span>
        <span>Member</span>
      </a>
      <a href="#setting" data-view="setting" class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg mx-2">
        <span class="material-icons-round">settings</span>
        <span>Setting</span>
      </a>
    </nav>
  </aside>

  <!-- Main Content Area -->
  <main class="flex-1 flex flex-col p-4 md:p-8 overflow-y-auto">
    <!-- ======================= APPOINTMENT VIEW ======================= -->
    <div id="view-appointment" class="view-content hidden">
      <div id="cards-section">
        <h2 class="text-2xl font-bold mb-4 text-slate-800">Active Bookings</h2>
        <div id="cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        <div id="more-container" class="mt-6 text-center"></div>
      </div>
      <div class="mt-8">
        <h2 class="text-2xl font-bold mb-4 text-slate-800">Booking History</h2>
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="overflow-x-auto">
            <table id="data-table" class="min-w-full text-sm">
              <thead class="bg-slate-50">
                <tr class="text-slate-600">
                  <th class="py-3 px-4 text-left">ห้องพัก</th>
                  <th class="py-3 px-4 text-left">เข้าพัก</th>
                  <th class="py-3 px-4 text-left">ออก</th>
                  <th class="py-3 px-4 text-left">ผู้จอง</th>
                  <th class="py-3 px-4 text-left">สถานะ</th>
                  <th class="py-3 px-4 text-center">จัดการ</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================= ROOM VIEW ======================= -->
    <div id="view-room" class="view-content hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-slate-800">Room Management</h2>
        <button class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md flex items-center space-x-2" onclick="showAddForm()">
          <span class="material-icons-round">add</span>
          <span>เพิ่มห้องพัก</span>
        </button>
      </div>
      <section id="formSection" class="bg-white shadow-lg rounded-lg p-6 hidden mb-6"></section>
      <section class="bg-white shadow-lg rounded-lg p-4">
        <h3 class="text-xl font-semibold mb-4 text-gray-700">รายการห้องพัก</h3>
        <div id="roomTable" class="overflow-x-auto"></div>
      </section>
    </div>

    <!-- ======================= MEMBER VIEW ======================= -->
    <div id="view-member" class="view-content hidden">
      <h2 class="text-2xl font-bold mb-4 text-slate-800">Member Management</h2>
      <div class="bg-white p-6 rounded-lg shadow-lg">
        <div class="flex flex-col md:flex-row md:space-x-4 mb-4">
          <div>
            <label for="filter-name" class="block text-sm font-medium text-gray-700">ค้นหาตามชื่อสกุล</label>
            <input type="text" id="filter-name" placeholder="พิมพ์ชื่อสกุล..." class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-slate-500 focus:border-slate-500" />
          </div>
          <div>
            <label for="filter-userline" class="block text-sm font-medium text-gray-700">ค้นหาตาม User ID Line</label>
            <input type="text" id="filter-userline" placeholder="พิมพ์ User ID..." class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-slate-500 focus:border-slate-500" />
          </div>
        </div>
        <div class="overflow-x-auto">
          <table id="member-data-table" class="min-w-full text-sm bg-white">
            <thead class="bg-slate-50">
              <tr class="text-slate-600">
                <th class="py-3 px-4 text-left">ไอดี</th>
                <th class="py-3 px-4 text-left">ชื่อสกุล</th>
                <th class="py-3 px-4 text-left">เบอร์ติดต่อ</th>
                <th class="py-3 px-4 text-left">คะแนน</th>
                <th class="py-3 px-4 text-center">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
        <div id="pagination" class="mt-4 flex justify-center items-center space-x-2"></div>
      </div>
    </div>

    <!-- ======================= SETTING VIEW (Placeholder) ======================= -->
    <div id="view-setting" class="view-content hidden">
      <h2 class="text-2xl font-bold mb-4 text-slate-800">Settings</h2>
      <div class="bg-white p-6 rounded-lg shadow-lg">
        <p>ส่วนของการตั้งค่าจะถูกเพิ่มที่นี่ในอนาคต</p>
      </div>
    </div>
  </main>

  <!-- ================================================================= -->
  <!-- MODALS (All Modals are placed here) -->
  <!-- ================================================================= -->

  <!-- Appointment: Update Payment Modal -->
  <div id="update-payment-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl w-full max-w-md transform transition-all" role="dialog">
      <h2 class="text-lg font-bold mb-4">อัพเดทการชำระเงิน</h2>
      <form id="update-payment-form">
        <input type="hidden" id="payment-update-id">
        <div class="mb-4">
          <label for="update-payment-select" class="block text-sm font-medium text-gray-700">การชำระเงิน</label>
          <select id="update-payment-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm rounded-md">
            <option value="ชำระเงินสำเร็จ">ชำระเงินสำเร็จ</option>
            <option value="จ่ายหน้าเค้าเตอร์">จ่ายหน้าเค้าเตอร์</option>
            <option value="ยกเลิก">ยกเลิก</option>
          </select>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="closePaymentModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">ยกเลิก</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Appointment: Update Check-In Modal -->
  <div id="update-checkin-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-xl w-full max-w-md transform transition-all" role="dialog">
        <h2 class="text-lg font-bold mb-4">อัพเดทข้อมูลเข้าพัก (Check-In)</h2>
        <form id="update-checkin-form">
          <input type="hidden" id="checkin-update-id">
          <div class="mb-4">
            <label for="update-checkin-time" class="block text-sm font-medium text-gray-700">เวลาเช็คอิน</label>
            <input type="datetime-local" id="update-checkin-time" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-slate-500 focus:border-slate-500">
          </div>
          <div class="mb-4">
            <label for="update-checkin-notes" class="block text-sm font-medium text-gray-700">บันทึกเพิ่มเติม</label>
            <textarea id="update-checkin-notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-slate-500 focus:border-slate-500" placeholder="..."></textarea>
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" onclick="closeCheckinModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">ยกเลิก</button>
            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">บันทึก</button>
          </div>
        </form>
      </div>
  </div>

  <!-- Appointment: Update Check-Out Modal -->
  <div id="update-checkout-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-xl w-full max-w-md transform transition-all" role="dialog">
        <h2 class="text-lg font-bold mb-4">อัพเดทข้อมูลเสร็จสิ้น (Check-Out)</h2>
        <form id="update-checkout-form">
          <input type="hidden" id="checkout-update-id">
          <div class="mb-4">
            <label for="update-checkout-time" class="block text-sm font-medium text-gray-700">เวลาเช็คเอาท์</label>
            <input type="datetime-local" id="update-checkout-time" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-slate-500 focus:border-slate-500">
          </div>
          <div class="mb-4">
            <label for="update-checkout-notes" class="block text-sm font-medium text-gray-700">บันทึกเพิ่มเติม</label>
            <textarea id="update-checkout-notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-slate-500 focus:border-slate-500" placeholder="..."></textarea>
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" onclick="closeCheckoutModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">ยกเลิก</button>
            <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-md">บันทึก</button>
          </div>
        </form>
      </div>
  </div>

  <!-- Appointment: Edit General Info Modal -->
  <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-xl w-full max-w-md transform transition-all" role="dialog">
        <h2 class="text-lg font-bold mb-4">แก้ไขข้อมูลการจอง</h2>
        <form id="edit-form" class="space-y-4">
          <input type="hidden" id="edit-id">
          <div><label for="edit-roomName" class="block text-sm font-medium text-gray-700">ชื่อห้องพัก</label><input type="text" id="edit-roomName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
          <div><label for="edit-checkinDate" class="block text-sm font-medium text-gray-700">วันที่เข้าพัก (DD-MM-YYYY)</label><input type="text" id="edit-checkinDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
          <div><label for="edit-checkoutDate" class="block text-sm font-medium text-gray-700">วันที่ออก (DD-MM-YYYY)</label><input type="text" id="edit-checkoutDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
          <div><label for="edit-numGuests" class="block text-sm font-medium text-gray-700">จำนวนคน</label><input type="number" id="edit-numGuests" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
          <div><label for="edit-bookerName" class="block text-sm font-medium text-gray-700">ชื่อผู้จอง</label><input type="text" id="edit-bookerName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
          <div><label for="edit-phone" class="block text-sm font-medium text-gray-700">เบอร์ติดต่อ</label><input type="text" id="edit-phone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
          <div class="flex justify-end space-x-3 pt-2">
            <button type="button" onclick="closeEditModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">ยกเลิก</button>
            <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md">บันทึก</button>
          </div>
        </form>
      </div>
  </div>

  <!-- Member: View Profile Modal -->
  <div id="profile-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-full max-w-lg transform transition-all" role="dialog">
      <h2 class="text-2xl mb-4 font-bold">ข้อมูลสมาชิก</h2>
      <div id="profile-content" class="space-y-2 text-sm"></div>
      <div class="flex justify-end mt-6">
        <button type="button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700" onclick="closeProfileModal()">ปิด</button>
      </div>
    </div>
  </div>

  <!-- Member: Edit Modal -->
  <div id="member-edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-full max-w-2xl transform transition-all" role="dialog">
      <h2 class="text-2xl mb-6 font-bold">แก้ไขข้อมูลสมาชิก</h2>
      <form id="member-edit-form">
        <input type="hidden" id="member-edit-id" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="member-edit-name" class="block text-sm font-medium text-gray-700">ชื่อสกุล</label><input type="text" id="member-edit-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required/></div>
          <div><label for="member-edit-phone" class="block text-sm font-medium text-gray-700">เบอร์ติดต่อ</label><input type="text" id="member-edit-phone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required/></div>
          <div><label for="member-edit-email" class="block text-sm font-medium text-gray-700">อีเมล</label><input type="email" id="member-edit-email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required/></div>
          <div><label for="member-edit-userline" class="block text-sm font-medium text-gray-700">useridline</label><input type="text" id="member-edit-userline" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required/></div>
          <div><label for="member-edit-score" class="block text-sm font-medium text-gray-700">คะแนน</label><input type="number" id="member-edit-score" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required/></div>
          <div><label for="member-edit-timestamp" class="block text-sm font-medium text-gray-700">เวลาบันทึก</label><input type="text" id="member-edit-timestamp" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="dd/mm/yyyy" required/></div>
        </div>
        <div class="flex justify-end mt-6 space-x-3">
          <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md" onclick="closeMemberEditModal()">ยกเลิก</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <script  >
// =================================================================
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzZ7QNIgh1I8mm0khQ4j-y2G0BGiUjHO3obmsnTokdSaencO3-BzPHUKIS8F6rP0Xf3OQ/exec'; 

const state = {
    appointmentDataLoaded: false,
    memberDataLoaded: false,
    roomDataLoaded: false,
};
// =================================================================
// 2. CORE APP LOGIC (Navigation and View Control)
// =================================================================
document.addEventListener('DOMContentLoaded', () => {
    const navLinks = document.querySelectorAll('.nav-link');
    
    window.navigateTo = (viewName) => {
        document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
        const targetView = document.getElementById(`view-${viewName}`);
        if (targetView) targetView.classList.remove('hidden');

        navLinks.forEach(link => {
            link.classList.toggle('active', link.dataset.view === viewName);
        });
        
        window.location.hash = viewName;
        loadDataForView(viewName);
    };

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(e.currentTarget.dataset.view);
        });
    });

    const initialView = window.location.hash.substring(1) || 'appointment';
    navigateTo(initialView);
});

function loadDataForView(viewName) {
    switch(viewName) {
        case 'appointment':
            if (!state.appointmentDataLoaded) {
                fetchAppointmentData();
                state.appointmentDataLoaded = true;
            }
            break;
        case 'member':
            if (!state.memberDataLoaded) {
                fetchMemberData();
                state.memberDataLoaded = true;
            }
            break;
        case 'room':
             if (!state.roomDataLoaded) {
                loadRooms();
                state.roomDataLoaded = true;
            }
            break;
    }
}

function startLoading() { document.getElementById('loading-overlay')?.classList.remove('hidden'); }
function stopLoading() { document.getElementById('loading-overlay')?.classList.add('hidden'); }

// =================================================================
// 3. APPOINTMENT MODULE
// =================================================================
let appointmentTableData = [];
let cardVisibleCount = 8;

function getStatusBadge(status) {
    const commonClasses = "px-2.5 py-1 text-xs font-semibold rounded-full";
    if (status === 'เสร็จสิ้น') return `<span class="${commonClasses} bg-green-100 text-green-800">${status}</span>`;
    if (status === 'ยกเลิก') return `<span class="${commonClasses} bg-red-100 text-red-800">${status}</span>`;
    if (status === 'จอง') return `<span class="${commonClasses} bg-yellow-100 text-yellow-800">${status}</span>`;
    if (status === 'เข้าพัก') return `<span class="${commonClasses} bg-blue-100 text-blue-800">${status}</span>`;
    return `<span class="${commonClasses} bg-gray-100 text-gray-800">${status || 'ไม่ระบุ'}</span>`;
}

async function fetchAppointmentData() {
    startLoading();
    try {
        const response = await fetch(`${WEB_APP_URL}?module=appointment`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        appointmentTableData = processAppointmentData(data);
        renderAppointmentTable(appointmentTableData);
        renderAppointmentCards();
    } catch (error) {
        console.error('Error fetching appointment data:', error);
        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถโหลดข้อมูล Booking ได้' });
    } finally {
        stopLoading();
    }
}

function processAppointmentData(data) {
    if (!Array.isArray(data) || data.length <= 1) return [];
    return data.slice(1).map(row => ({ id: String(row[0]), roomId: row[1], roomName: row[2], roomPrice: row[4], checkinDate: row[5], checkoutDate: row[6], numGuests: row[7], bookerName: row[8], phone: row[9], status: row[12], payment: row[13], checkInTime: row[14], checkOutTime: row[15], additionalNotes: row[16] }));
}

function formatDateDMY(dateStr) {
    if (!dateStr) return '';
    if (dateStr.includes('T')) {
        const date = new Date(dateStr);
        return new Intl.DateTimeFormat('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'Asia/Bangkok' }).format(date).replace(/\//g, '-');
    }
    return dateStr;
}

function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '';
    let date;
    if (dateTimeStr.includes('T')) {
        date = new Date(dateTimeStr);
    } else {
        const parts = dateTimeStr.split(' ');
        if (parts.length < 2) return dateTimeStr;
        const dateParts = parts[0].split('-');
        if (dateParts.length < 3) return dateTimeStr;
        const isoDateStr = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}T${parts[1]}:00`;
        date = new Date(isoDateStr);
    }
    return new Intl.DateTimeFormat('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok' }).format(date).replace(',', '').replace(/\//g, '-');
}

function convertToDatetimeLocalFormat(dateTimeStr) {
    if (!dateTimeStr) return new Date().toISOString().slice(0, 16);
    const parts = dateTimeStr.split(' ');
    if (parts.length < 2) return '';
    const dateParts = parts[0].split('-');
    if (dateParts.length < 3) return '';
    return `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}T${parts[1]}`;
}

function renderAppointmentTable(data) {
    const tbody = document.querySelector('#data-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const filteredData = data.filter(item => item.status === 'เสร็จสิ้น' || item.status === 'ยกเลิก').sort((a,b) => new Date(b.checkOutTime || 0) - new Date(a.checkOutTime || 0));
    filteredData.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="py-2 px-4">${item.roomName}</td>
            <td class="py-2 px-4">${formatDateDMY(item.checkinDate)}</td>
            <td class="py-2 px-4">${formatDateDMY(item.checkoutDate)}</td>
            <td class="py-2 px-4">${item.bookerName}</td>
            <td class="py-2 px-4">${getStatusBadge(item.status)}</td>
            <td class="py-2 px-4 text-center">
                <div class="flex space-x-1 justify-center">
                    <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full" onclick="toggleDetails('${item.id}', this)" title="แสดงรายละเอียด"><span class="material-icons-round text-base text-gray-700">visibility</span></button>
                    <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full" onclick="openEditModal('${item.id}')" title="แก้ไข"><span class="material-icons-round text-base text-gray-700">edit</span></button>
                    <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full" onclick="deleteRecord('${item.id}')" title="ลบ"><span class="material-icons-round text-base text-gray-700">delete</span></button>
                </div>
            </td>`;
        tbody.appendChild(tr);
    });
}

function toggleDetails(id, btn) {
    const currentRow = btn.closest('tr');
    const nextRow = currentRow.nextElementSibling;
    if (nextRow && nextRow.classList.contains('details-row')) {
        nextRow.remove();
        btn.innerHTML = `<span class="material-icons-round text-base text-gray-700">visibility</span>`;
        return;
    }
    const item = appointmentTableData.find(x => String(x.id) === String(id));
    if (!item) return;
    btn.innerHTML = `<span class="material-icons-round text-base text-gray-700">visibility_off</span>`;
    const detailsRow = document.createElement('tr');
    detailsRow.classList.add('details-row', 'bg-slate-50');
    detailsRow.innerHTML = `
        <td colspan="6" class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
                <div><strong>รหัสการจอง:</strong> ${item.id}</div>
                <div><strong>ราคา:</strong> ${item.roomPrice || '-'} บาท</div>
                <div><strong>จำนวนคน:</strong> ${item.numGuests || '-'}</div>
                <div><strong>เบอร์ติดต่อ:</strong> ${item.phone}</div>
                <div><strong>การชำระเงิน:</strong> ${item.payment}</div>
                <div><strong>เช็คอิน:</strong> ${formatDateTime(item.checkInTime) || 'ยังไม่เช็คอิน'}</div>
                <div><strong>เช็คเอาท์:</strong> ${formatDateTime(item.checkOutTime) || 'ยังไม่เช็คเอาท์'}</div>
                <div class="col-span-full"><strong>บันทึกเพิ่มเติม:</strong> ${item.additionalNotes || '-'}</div>
            </div>
        </td>`;
    currentRow.after(detailsRow);
}

function renderAppointmentCards() {
    const cardsContainer = document.getElementById('cards-container');
    if (!cardsContainer) return;
    const filtered = appointmentTableData.filter(item => item.status !== 'เสร็จสิ้น' && item.status !== 'ยกเลิก');
    cardsContainer.innerHTML = '';
    const visibleItems = filtered.slice(0, cardVisibleCount);
    visibleItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-xl shadow-md flex flex-col justify-between';
        card.innerHTML = `
            <div>
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-lg font-bold text-slate-800">${item.roomName}</h3>
                    ${getStatusBadge(item.status)}
                </div>
                <p class="text-sm text-gray-600">ผู้จอง: ${item.bookerName}</p>
                <p class="text-sm text-gray-600">โทร: ${item.phone}</p>
                <div class="my-2 border-t border-gray-200"></div>
                <p class="text-sm text-gray-600">เข้า: ${formatDateDMY(item.checkinDate)}</p>
                <p class="text-sm text-gray-600">ออก: ${formatDateDMY(item.checkoutDate)}</p>
                <p class="text-sm text-gray-600 mt-1">การชำระเงิน: <span class="font-semibold text-slate-700">${item.payment}</span></p>
            </div>
            <div class="flex mt-4 space-x-2 justify-end">
                <button class="bg-blue-100 hover:bg-blue-200 p-2 rounded-full" onclick="openPaymentModal('${item.id}')" title="อัพเดทการชำระเงิน"><span class="material-icons-round text-base text-blue-700">payment</span></button>
                <button class="bg-green-100 hover:bg-green-200 p-2 rounded-full" onclick="openCheckinModal('${item.id}')" title="อัพเดทเข้าพัก"><span class="material-icons-round text-base text-green-700">how_to_reg</span></button>
                <button class="bg-orange-100 hover:bg-orange-200 p-2 rounded-full" onclick="openCheckoutModal('${item.id}')" title="อัพเดทเสร็จสิ้น"><span class="material-icons-round text-base text-orange-700">exit_to_app</span></button>
                <button class="bg-yellow-100 hover:bg-yellow-200 p-2 rounded-full" onclick="openEditModal('${item.id}')" title="แก้ไข"><span class="material-icons-round text-base text-yellow-700">edit</span></button>
                <button class="bg-red-100 hover:bg-red-200 p-2 rounded-full" onclick="deleteRecord('${item.id}')" title="ลบ"><span class="material-icons-round text-base text-red-700">delete</span></button>
            </div>`;
        cardsContainer.appendChild(card);
    });
    const moreContainer = document.getElementById('more-container');
    if (filtered.length > cardVisibleCount) {
        moreContainer.innerHTML = `<button onclick="showMoreCards()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">แสดงเพิ่มเติม</button>`;
    } else {
        moreContainer.innerHTML = '';
    }
}

window.showMoreCards = function() {
    const filtered = appointmentTableData.filter(item => item.status !== 'เสร็จสิ้น' && item.status !== 'ยกเลิก');
    cardVisibleCount = filtered.length;
    renderAppointmentCards();
}

// Appointment Modal Functions
window.openPaymentModal = (id) => { const item = appointmentTableData.find(x => x.id === id); if (!item) return; $('#payment-update-id').val(item.id); $('#update-payment-select').val(item.payment || 'รอการชำระเงิน'); $('#update-payment-modal').removeClass('hidden'); };
window.closePaymentModal = () => $('#update-payment-modal').addClass('hidden');
window.openCheckinModal = (id) => { const item = appointmentTableData.find(x => x.id === id); if (!item) return; $('#checkin-update-id').val(item.id); $('#update-checkin-time').val(convertToDatetimeLocalFormat(item.checkInTime)); $('#update-checkin-notes').val(item.additionalNotes || ''); $('#update-checkin-modal').removeClass('hidden'); };
window.closeCheckinModal = () => $('#update-checkin-modal').addClass('hidden');
window.openCheckoutModal = (id) => { const item = appointmentTableData.find(x => x.id === id); if (!item) return; $('#checkout-update-id').val(item.id); $('#update-checkout-time').val(convertToDatetimeLocalFormat(item.checkOutTime)); $('#update-checkout-notes').val(item.additionalNotes || ''); $('#update-checkout-modal').removeClass('hidden'); };
window.closeCheckoutModal = () => $('#update-checkout-modal').addClass('hidden');
window.openEditModal = (id) => { const item = appointmentTableData.find(x => x.id === id); if (!item) return; $('#edit-id').val(item.id); $('#edit-roomName').val(item.roomName); $('#edit-checkinDate').val(formatDateDMY(item.checkinDate)); $('#edit-checkoutDate').val(formatDateDMY(item.checkoutDate)); $('#edit-numGuests').val(item.numGuests); $('#edit-bookerName').val(item.bookerName); $('#edit-phone').val(item.phone); $('#edit-modal').removeClass('hidden'); };
window.closeEditModal = () => $('#edit-modal').addClass('hidden');

// Appointment Form Submissions
$('#update-payment-form').on('submit', function(e) { e.preventDefault(); startLoading(); const data = { module: 'appointment', method: 'updatePaymentData', id: $('#payment-update-id').val(), payment: $('#update-payment-select').val() }; $.post(WEB_APP_URL, data).done(() => { Swal.fire({ icon: 'success', title: 'อัพเดทสำเร็จ', timer: 1500, showConfirmButton: false }); fetchAppointmentData(); closePaymentModal(); }).fail(() => Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด' })).always(stopLoading); });
$('#update-checkin-form').on('submit', function(e) { e.preventDefault(); startLoading(); const data = { module: 'appointment', method: 'updateCheckInData', id: $('#checkin-update-id').val(), checkInTime: $('#update-checkin-time').val(), additionalNotes: $('#update-checkin-notes').val() }; $.post(WEB_APP_URL, data).done(() => { Swal.fire({ icon: 'success', title: 'อัพเดทสำเร็จ', timer: 1500, showConfirmButton: false }); fetchAppointmentData(); closeCheckinModal(); }).fail(() => Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด' })).always(stopLoading); });
$('#update-checkout-form').on('submit', function(e) { e.preventDefault(); startLoading(); const data = { module: 'appointment', method: 'updateCheckOutData', id: $('#checkout-update-id').val(), checkOutTime: $('#update-checkout-time').val(), additionalNotes: $('#update-checkout-notes').val() }; $.post(WEB_APP_URL, data).done(() => { Swal.fire({ icon: 'success', title: 'อัพเดทสำเร็จ', timer: 1500, showConfirmButton: false }); fetchAppointmentData(); closeCheckoutModal(); }).fail(() => Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด' })).always(stopLoading); });
$('#edit-form').on('submit', function(e) { e.preventDefault(); startLoading(); const data = { module: 'appointment', method: 'editAppointmentData', id: $('#edit-id').val(), roomName: $('#edit-roomName').val(), checkinDate: $('#edit-checkinDate').val(), checkoutDate: $('#edit-checkoutDate').val(), numGuests: $('#edit-numGuests').val(), bookerName: $('#edit-bookerName').val(), phone: $('#edit-phone').val() }; $.post(WEB_APP_URL, data).done(() => { Swal.fire({ icon: 'success', title: 'แก้ไขเรียบร้อย', timer: 1500, showConfirmButton: false }); fetchAppointmentData(); closeEditModal(); }).fail(() => Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด' })).always(stopLoading); });

window.deleteRecord = (id) => {
    Swal.fire({ title: 'ยืนยันการลบ?', text: "คุณต้องการลบข้อมูลนี้ใช่หรือไม่?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก' }).then((result) => {
        if (result.isConfirmed) {
            startLoading();
            $.post(WEB_APP_URL, { module: 'appointment', method: 'deleteAppointmentData', id: id }).done(() => { Swal.fire({ icon: 'success', title: 'ลบเรียบร้อย', timer: 1500, showConfirmButton: false }); fetchAppointmentData(); }).fail(() => Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด' })).always(stopLoading);
        }
    });
};


// =================================================================
// 4. MEMBER MODULE
// =================================================================
let memberTableData = [];
let memberFilteredData = [];
let memberCurrentPage = 1;
const memberRowsPerPage = 10;

async function fetchMemberData() {
    startLoading();
    try {
        const response = await fetch(`${WEB_APP_URL}?module=member`);
        const data = await response.json();
        memberTableData = data.slice(1);
        memberFilteredData = memberTableData.slice();
        displayMemberPage(memberCurrentPage);
        setupMemberPagination();
    } catch (error) {
        console.error('Error fetching member data:', error);
        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถโหลดข้อมูล Member ได้' });
    } finally {
        stopLoading();
    }
}

function displayMemberPage(page) {
    const startIndex = (page - 1) * memberRowsPerPage;
    const endIndex = startIndex + memberRowsPerPage;
    const paginatedData = memberFilteredData.slice(startIndex, endIndex);
    const tableBody = document.querySelector("#member-data-table tbody");
    tableBody.innerHTML = "";
    paginatedData.forEach((row) => {
        if (row.every(cell => cell === "")) return;
        const tr = document.createElement("tr");
        tr.className = 'hover:bg-gray-50';
        // row[0]: ไอดี, row[1]: ชื่อสกุล, row[2]: เบอร์ติดต่อ, row[5]: คะแนน
        [row[0], row[1], row[2], row[5]].forEach(cellData => {
            const td = document.createElement("td");
            td.textContent = cellData;
            td.className = "py-2 px-4";
            tr.appendChild(td);
        });
        const actionTd = document.createElement("td");
        actionTd.className = "py-2 px-4 text-center";
        actionTd.innerHTML = `<div class="flex space-x-2 justify-center">
            <button onclick="viewProfile('${row[0]}')" class="bg-green-500 text-white py-1 px-3 rounded hover:bg-green-700 text-xs">ดู</button>
            <button onclick="openMemberEditModal('${row[0]}')" class="bg-yellow-500 text-white py-1 px-3 rounded hover:bg-yellow-700 text-xs">แก้ไข</button>
            <button onclick="confirmMemberDelete('${row[0]}')" class="bg-red-500 text-white py-1 px-3 rounded hover:bg-red-700 text-xs">ลบ</button>
        </div>`;
        tr.appendChild(actionTd);
        tableBody.appendChild(tr);
    });
}

function setupMemberPagination() {
    const pageCount = Math.ceil(memberFilteredData.length / memberRowsPerPage);
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";
    if (pageCount <= 1) return;
    for (let i = 1; i <= pageCount; i++) {
        const pageButton = document.createElement("button");
        pageButton.textContent = i;
        pageButton.className = `py-1 px-3 text-sm rounded-md ${i === memberCurrentPage ? "bg-slate-500 text-white" : "bg-gray-300 text-slate-800 hover:bg-gray-400"}`;
        pageButton.onclick = () => { memberCurrentPage = i; displayMemberPage(i); updateMemberPaginationButtons(); };
        pagination.appendChild(pageButton);
    }
}

function updateMemberPaginationButtons() {
    const pagination = document.getElementById("pagination");
    pagination.querySelectorAll("button").forEach(button => {
        button.className = `py-1 px-3 text-sm rounded-md ${parseInt(button.textContent) === memberCurrentPage ? "bg-slate-500 text-white" : "bg-gray-300 text-slate-800 hover:bg-gray-400"}`;
    });
}

function applyMemberFilters() {
    const nameValue = document.getElementById("filter-name").value.toLowerCase();
    const userlineValue = document.getElementById("filter-userline").value.toLowerCase();
    memberFilteredData = memberTableData.filter(row => {
        const name = row[1] ? row[1].toLowerCase() : "";
        const userline = row[4] ? row[4].toLowerCase() : "";
        return name.includes(nameValue) && userline.includes(userlineValue);
    });
    memberCurrentPage = 1;
    displayMemberPage(memberCurrentPage);
    setupMemberPagination();
}

$('#filter-name, #filter-userline').on('input', applyMemberFilters);

window.viewProfile = (id) => {
    const row = memberTableData.find(r => r[0] == id);
    if (!row) return;
    $('#profile-content').html(`<p><strong>ไอดี:</strong> ${row[0]}</p><p><strong>ชื่อสกุล:</strong> ${row[1]}</p><p><strong>เบอร์ติดต่อ:</strong> ${row[2]}</p><p><strong>อีเมล:</strong> ${row[3]}</p><p><strong>useridline:</strong> ${row[4]}</p><p><strong>คะแนน:</strong> ${row[5]}</p><p><strong>เวลาบันทึก:</strong> ${row[6]}</p>`);
    $('#profile-modal').removeClass('hidden');
};
window.closeProfileModal = () => $('#profile-modal').addClass('hidden');

window.openMemberEditModal = (id) => {
    const row = memberTableData.find(r => r[0] == id);
    if (!row) return;
    $('#member-edit-id').val(row[0]);
    $('#member-edit-name').val(row[1]);
    $('#member-edit-phone').val(row[2]);
    $('#member-edit-email').val(row[3]);
    $('#member-edit-userline').val(row[4]);
    $('#member-edit-score').val(row[5]);
    $('#member-edit-timestamp').val(row[6]);
    $('#member-edit-modal').removeClass('hidden');
};
window.closeMemberEditModal = () => $('#member-edit-modal').addClass('hidden');

$('#member-edit-form').on('submit', async function(e) {
    e.preventDefault();
    startLoading();
    const data = `module=member&method=updateData&id=${$('#member-edit-id').val()}&nameId=${encodeURIComponent($('#member-edit-name').val())}&phone=${encodeURIComponent($('#member-edit-phone').val())}&email=${encodeURIComponent($('#member-edit-email').val())}&userlineId=${encodeURIComponent($('#member-edit-userline').val())}&score=${$('#member-edit-score').val()}×tamp=${encodeURIComponent($('#member-edit-timestamp').val())}`;
    try {
        await fetch(WEB_APP_URL, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: data });
        Swal.fire({ title: "สำเร็จ", icon: "success", timer: 1500, showConfirmButton: false });
        await fetchMemberData();
        closeMemberEditModal();
    } catch (error) {
        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด' });
    } finally {
        stopLoading();
    }
});

window.confirmMemberDelete = (id) => {
    Swal.fire({ title: "คุณแน่ใจหรือไม่?", text: "ต้องการลบข้อมูลสมาชิกนี้?", icon: "warning", showCancelButton: true, confirmButtonColor: "#d33", cancelButtonColor: "#3085d6", confirmButtonText: "ใช่, ลบเลย!", cancelButtonText: 'ยกเลิก' }).then(async (result) => {
        if (result.isConfirmed) {
            startLoading();
            try {
                await fetch(WEB_APP_URL, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: `module=member&method=deleteData&id=${id}` });
                Swal.fire({ title: "ลบเรียบร้อย", icon: "success", timer: 1500, showConfirmButton: false });
                await fetchMemberData();
            } catch (error) {
                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด' });
            } finally {
                stopLoading();
            }
        }
    });
};


// =================================================================
// 5. ROOM MODULE
// =================================================================
// (This entire section is self-contained and will be initialized by loadDataForView)
// No changes needed from the full version provided in the previous answer.
// Just copy and paste the entire ROOM MODULE javascript code here.
// For brevity, I will show the starting functions.

function setupPreview(fileInputId, previewImgId) {
    const input = document.getElementById(fileInputId);
    if(input) input.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById(previewImgId);
                if(preview) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                }
            };
            reader.readAsDataURL(this.files[0]);
        }
    });
}

function processFilePromise(inputId, oldFieldId, base64Key, mimeKey, actualField, roomObj) {
    return new Promise((resolve, reject) => {
        var fileInput = document.getElementById(inputId);
        if (fileInput && fileInput.files.length > 0) {
            var reader = new FileReader();
            reader.onload = (event) => {
                roomObj[base64Key] = event.target.result.split(',')[1];
                roomObj[mimeKey] = fileInput.files[0].type;
                resolve();
            };
            reader.onerror = reject;
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            roomObj[base64Key] = "";
            roomObj[mimeKey] = "";
            const oldInput = document.getElementById(oldFieldId);
            if(oldInput) roomObj[actualField] = oldInput.value;
            resolve();
        }
    });
}

async function loadRooms() {
    startLoading();
    try {
        const response = await fetch(`${WEB_APP_URL}?module=room&action=fetchData`);
        const rooms = await response.json();
        let html = `<table class="min-w-full text-sm">
            <thead class="bg-slate-50"><tr class="text-slate-600">
            <th class="py-3 px-3 text-left">รูปปก</th><th class="py-3 px-3 text-left">ไอดีห้อง</th>
            <th class="py-3 px-3 text-left">ชื่อ</th><th class="py-3 px-3 text-left">หมวดหมู่</th>
            <th class="py-3 px-3 text-left">ราคา</th><th class="py-3 px-3 text-left">สถานะ</th>
            <th class="py-3 px-3 text-center">Actions</th>
            </tr></thead><tbody class="divide-y divide-gray-200">`;
        rooms.forEach(room => {
            const cover = room["รูปภาพ"] ? `<img src="${room["รูปภาพ"]}" alt="cover" class="w-16 h-12 object-cover rounded">` : `<div class="w-16 h-12 bg-gray-200 rounded"></div>`;
            html += `<tr class="hover:bg-gray-50">
                <td class="py-2 px-3">${cover}</td><td class="py-2 px-3">${room["ไอดีห้อง"]}</td>
                <td class="py-2 px-3 font-semibold">${room["ชื่อ"]}</td><td class="py-2 px-3">${room["หมวดหมู่"]}</td>
                <td class="py-2 px-3">${room["ราคา"]}</td><td class="py-2 px-3">${room["สถานะ"]}</td>
                <td class="py-2 px-3 text-center"><div class="flex space-x-1 justify-center">
                <button class="bg-slate-500 hover:bg-slate-700 text-white py-1 px-2 rounded text-xs" onclick="showRoomDetails('${room["ไอดีห้อง"]}')">รายละเอียด</button>
                <button class="bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-2 rounded text-xs" onclick="editRoom('${room["ไอดีห้อง"]}')">แก้ไข</button>
                <button class="bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded text-xs" onclick="deleteRoom('${room["ไอดีห้อง"]}')">ลบ</button>
                </div></td></tr>`;
        });
        html += `</tbody></table>`;
        $('#roomTable').html(html);
    } catch(e) {
        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถโหลดข้อมูลห้องพักได้' });
    } finally {
        stopLoading();
    }
}

$('#roomForm').on('submit', async function (e) {
    e.preventDefault();
    startLoading();
    let room = {};
    const checkboxFields = ["Wi‑Fi", "ห้องอาหาร", "สระว่ายน้ำ", "ที่จอดรถ", "นวด"];
    checkboxFields.forEach(field => {
        const checkbox = this.elements[field];
        if (checkbox) room[field] = checkbox.checked ? "TRUE" : "FALSE";
    });
    try {
        await Promise.all([
            processFilePromise("coverInput", "รูปภาพOLD", "รูปภาพBase64", "รูปภาพMimeType", "รูปภาพ", room),
            processFilePromise("image1Input", "รูปประกอบ-1OLD", "รูปประกอบ-1Base64", "รูปประกอบ-1MimeType", "รูปประกอบ-1", room),
            processFilePromise("image2Input", "รูปประกอบ-2OLD", "รูปประกอบ-2Base64", "รูปประกอบ-2MimeType", "รูปประกอบ-2", room),
            processFilePromise("image3Input", "รูปประกอบ-3OLD", "รูปประกอบ-3Base64", "รูปประกอบ-3MimeType", "รูปประกอบ-3", room),
            processFilePromise("image4Input", "รูปประกอบ-4OLD", "รูปประกอบ-4Base64", "รูปประกอบ-4MimeType", "รูปประกอบ-4", room)
        ]);
        let formData = new FormData(this);
        formData.forEach((value, key) => {
            if (!checkboxFields.includes(key) && !key.includes('OLD') && !key.startsWith('รูป')) {
                room[key] = value;
            }
        });
        const response = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ module: "room", action: "insertOrUpdate", data: room }) });
        const result = await response.json();
        if (result.status === "success") {
            Swal.fire({ icon: "success", title: "บันทึกสำเร็จ!", showConfirmButton: false, timer: 1500 });
            this.reset();
            hideForm();
            loadRooms();
        } else { throw new Error(result.message); }
    } catch(e) {
        Swal.fire({ icon: "error", title: "เกิดข้อผิดพลาด", text: e.message });
    } finally {
        stopLoading();
    }
});

window.showRoomDetails = async (id) => {
    startLoading();
    try {
        const res = await fetch(`${WEB_APP_URL}?module=room&action=fetchData`);
        const rooms = await res.json();
        const roomData = rooms.find(r => r["ไอดีห้อง"] == id);
        if (roomData) {
            let mainImageUrl = roomData["รูปภาพ"] || "https://via.placeholder.com/400x300.png?text=No+Image";
            let thumbnails = [ "รูปภาพ", "รูปประกอบ-1", "รูปประกอบ-2", "รูปประกอบ-3", "รูปประกอบ-4" ]
                .filter(key => roomData[key])
                .map(key => `<img src="${roomData[key]}" class="w-16 h-16 object-cover border-2 border-transparent hover:border-blue-500 rounded cursor-pointer" onclick="document.getElementById('swalMainImage').src='${roomData[key]}'">`)
                .join('');
            let checkboxHtml = ["Wi‑Fi", "ห้องอาหาร", "สระว่ายน้ำ", "ที่จอดรถ", "นวด"]
                .filter(field => String(roomData[field]).toUpperCase() === "TRUE")
                .map(field => `<span class="inline-block bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${field}</span>`)
                .join('');
            let htmlContent = `...`; // Full HTML content for Swal
            Swal.fire({ title: "รายละเอียดห้องพัก", html: htmlContent, width: "800px", showCloseButton: true, showConfirmButton: false });
        }
    } catch(e) {
        console.error("Error in showRoomDetails:", e);
    } finally {
        stopLoading();
    }
};

window.editRoom = async (id) => {
    startLoading();
    try {
        const res = await fetch(`${WEB_APP_URL}?module=room&action=fetchData`);
        const rooms = await res.json();
        const roomData = rooms.find(r => r["ไอดีห้อง"] == id);
        if (roomData) {
            let form = document.getElementById("roomForm");
            form.reset();
            for (let key in roomData) {
                if (form.elements[key] && form.elements[key].type !== "file" && form.elements[key].type !== "checkbox") {
                    form.elements[key].value = roomData[key];
                }
            }
            ["Wi‑Fi", "ห้องอาหาร", "สระว่ายน้ำ", "ที่จอดรถ", "นวด"].forEach(field => {
                const checkbox = form.elements[field];
                if(checkbox) checkbox.checked = (String(roomData[field]).toUpperCase() === "TRUE");
            });
            if (form.elements["สถานะ"]) form.elements["สถานะ"].value = roomData["สถานะ"] || "";
            if (form.elements["ไอดีห้อง"]) form.elements["ไอดีห้อง"].readOnly = true;
            showAddForm(); // Re-use show form logic
            document.getElementById("formTitle").textContent = "แก้ไขข้อมูลห้องพัก";
        }
    } catch(e) {
        console.error("Error in editRoom:", e);
    } finally {
        stopLoading();
    }
};

window.deleteRoom = (id) => {
    Swal.fire({ title: "ยืนยันการลบ?", text: `ต้องการลบห้องพักรหัส ${id} ใช่หรือไม่?`, icon: "warning", showCancelButton: true, confirmButtonColor: "#d33", cancelButtonColor: "#3085d6", confirmButtonText: "ใช่, ลบเลย!", cancelButtonText: 'ยกเลิก' }).then(async (result) => {
        if (result.isConfirmed) {
            startLoading();
            try {
                const response = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ module: "room", action: "delete", id: id }) });
                const res = await response.json();
                if (res.status === "success") {
                    Swal.fire({ icon: "success", title: "ลบเรียบร้อย", showConfirmButton: false, timer: 1500 });
                    loadRooms();
                } else { throw new Error(res.message); }
            } catch(e) {
                Swal.fire({ icon: "error", title: "เกิดข้อผิดพลาด", text: e.message });
            } finally {
                stopLoading();
            }
        }
    });
};

window.showAddForm = () => {
    let form = document.getElementById("formSection");
    if(form.innerHTML === '') { // Lazy load form content
        form.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-semibold text-gray-700" id="formTitle">บันทึกข้อมูลห้องพัก</h2>
          <button class="text-red-500 hover:text-red-700" onclick="hideForm()"><span class="material-icons-round">close</span></button>
        </div>
        <form id="roomForm" class="space-y-4">
          <!-- (คัดลอกเนื้อหา form ทั้งหมดจาก room.html เดิมมาวางที่นี่) -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div><label class="block text-sm font-medium text-gray-600">ไอดีห้อง</label><input type="text" name="ไอดีห้อง" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm" placeholder="เว้นว่างเพื่อสร้างอัตโนมัติ"></div>
              <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-600">ชื่อห้อง</label><input type="text" name="ชื่อ" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm"></div>
          </div>
          <!-- More fields... -->
          <div><button type="submit" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 px-4 rounded-md text-lg">บันทึกข้อมูล</button></div>
        </form>
        `;
        // Re-attach event listener for the new form
        $('#roomForm').on('submit', async function(e) { /* ... Same submit logic ... */ });
        // Re-setup previews
        setupPreview('coverInput', 'coverPreview');
        setupPreview('image1Input', 'image1Preview');
        // ... etc
    }
    
    let formElement = document.getElementById("roomForm");
    formElement.reset();
    if (formElement.elements["ไอดีห้อง"]) formElement.elements["ไอดีห้อง"].readOnly = false;
    document.getElementById("formTitle").textContent = "บันทึกข้อมูลห้องพัก";
    document.getElementById("formSection").classList.remove("hidden");
    window.scrollTo(0, 0);
};

window.hideForm = () => document.getElementById("formSection").classList.add("hidden");


  </script>
</body>
</html>
